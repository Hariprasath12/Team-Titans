<!DOCTYPE html>
<html lang="en">
	<head>
		{{> head title="Carbon Footprint - Ride Stats"}}
		<style type="text/css">
			.map-container {
				height: 100%;
				opacity: .5;
			}
		</style>
	</head>
	<body>
		<div id="header">
			{{> topNav}}
		</div>
		<div id="content">
			<div class="container">
				<div class="map-container">
					<div id="map-canvas" style="width: 375px; height: 389px;">
						
					</div>
				</div>
				<div class="commute-results-container">
					<div class="commute-results">
				  		<h3>Hope you had a Nice Journey!</h3>
					  	<div id="from">
					  	</div>
						<div id="to">
						</div>
						<div id="carbon-emitted">
						</div>
						<div id="carbon-saved">
						</div>
						<div id="leaf-points">
							
						</div>
					</div>
				</div>
			</div>
		</div>
		<div id="footer">
			{{> bottomNav}}
		</div>
		<script>
			let commute = JSON.parse(localStorage.getItem("commute"));
			console.log(commute);

			let from, to, count, ride, dis;

			if(commute) {
		        from = commute.start;
			    to = commute.end;

			    count = commute.count;
			    ride= commute.ride;
			    dis= commute.distance;

			    document.getElementById('from').innerHTML=`From: ${from.toUpperCase()}`;
			    document.getElementById('to').innerHTML=`To: ${to.toUpperCase()}`;
			}

		    var months = new Array();
			months[0] = "January";
			months[1] = "February";
			months[2] = "March";
			months[3] = "April";
			months[4] = "May";
			months[5] = "June";
			months[6] = "July";
			months[7] = "August";
			months[8] = "September";
			months[9] = "October";
			months[10] = "November";
			months[11] = "December";

			var d = new Date();
			var day = d.getDate().toString();
			var month = months[d.getMonth()].toLowerCase();
			var year = d.getFullYear().toString();

		    function initMap() {		    
		      var directionsService = new google.maps.DirectionsService();
		      var directionsRenderer = new google.maps.DirectionsRenderer();
		      var map = new google.maps.Map(document.getElementById('map-canvas'), {
		        zoom: 7,
		        center: {lat: 41.85, lng: -87.65}
		      });
		      directionsRenderer.setMap(map);

		      var onChangeHandler = function() {
		        calculateAndDisplayRoute(directionsService, directionsRenderer);
		      };
		      if(commute) {
		      	document.body.addEventListener('load', onChangeHandler);
		      }
		    }

	        function calculateAndDisplayRoute(directionsService, directionsRenderer) {
    		    directionsService.route(
                {
                  origin: {query: from},
                  destination: {query: to},
                  travelMode: 'DRIVING'
                },
                function(response, status) {
                  if (status === 'OK') {
                    directionsRenderer.setDirections(response);
                  } else {
                    window.alert('Directions request failed due to ' + status);
                  }
                });
	        }

	        function calculateCarbon(ride) {
	        	let mileage;
	        	let leafPoints;
	        	let rideLeafPoints = 0;

	        	if(ride == "bike") {
	        		mileage = 50;
	        		leafPoints = 15;
	        	} else if(ride == "car") {
	        		mileage = 20;
	        		leafPoints = 10;
	        	} else if(ride == "bus") {
	        		mileage = 5;
	        		leafPoints = 15;
	        	} else if(ride == "train") {
	        		mileage = 5;
	        		leafPoints = 20;
	        	} else {
	        		leafPoints = 25;
	        	}

	        	
	        	let totalOccupants = commute.count;
	        	let carbonEmittedPerLitre;
	        	if(ride == "bike") {
	        		carbonEmittedPerLitre = 2.31;
	        	} else {
	        		carbonEmittedPerLitre = 2.68;
	        	}

	        	let fuelRequiredPerPerson = (dis/mileage);
	        	let totalFuelRequired = ((dis/mileage)/totalOccupants);

	        	let carbonEmissionPerPerson = carbonEmittedPerLitre * fuelRequiredPerPerson;
	        	let totalCarbonEmission;
	        	let carbonSaved;

	        	// console.log(carbonEmissionPerPerson);

	        	if(ride == "walk" || ride == "cycle") {
	        		carbonSaved = carbonEmittedPerLitre;
	        	} else {
	        		carbonSaved = 0;
	        	}
	        	
	        	
	        	if(totalOccupants == 1) {
	        		totalCarbonEmission = carbonEmissionPerPerson;
	        		rideLeafPoints = dis * 4;
	        	} else {
	        		totalCarbonEmission = carbonEmittedPerLitre * totalFuelRequired;
	        		carbonSaved = carbonEmissionPerPerson - totalCarbonEmission;
	        		rideLeafPoints = dis * 4 * leafPoints;
	        	}

	        	commute.totalCarbonEmission = totalCarbonEmission;
	        	commute.carbonSaved = carbonSaved;
	        	commute.rideLeafPoints = rideLeafPoints;

	        	localStorage.setItem("commute", JSON.stringify(commute));

	        	saveCommuteDetails(commute);

	        	if(ride == "walk" || ride == "cycle") {
	        		document.getElementById('carbon-emitted').innerHTML="Carbon Emitted: 0. Yay! You took a cabon free ride.";
	        	} else {
	        		document.getElementById('carbon-emitted').innerHTML=`Carbon Emitted: ${totalCarbonEmission} KG`;
	        	}
	        	document.getElementById('carbon-saved').innerHTML=`Carbon Saved: ${carbonSaved} KG`;
	        	document.getElementById('leaf-points').innerHTML=`Leaf Points Earned: ${rideLeafPoints}`;
	        }

	        if(commute) {
	        	calculateCarbon(commute.ride);
	        }

	        function rebuildCommuteDetails(my_tanso_details) {
				var commute_details = my_tanso_details["commute_details"];
				// console.log('test');
				// console.log(commute_details);

				if(my_tanso_details["commute_details"][year] == undefined) {
					commute_details[year] = {};
					commute_details[year][month] = {};
					commute_details[year][month]["daily_commute_details"] = {};
					commute_details[year][month]["daily_commute_details"][day] = {};
					commute_details[year][month]["daily_commute_details"][day]["commutes"] = [];
					commute_details[year][month]["carbon_stats"] = {
						"carbon_emitted": 0,
						"carbon_saved": 0,
						"leaf_points": 0
					}
				} else {
					if(my_tanso_details["commute_details"][year][month] == undefined) {
						commute_details[year][month] = {};
						commute_details[year][month]["daily_commute_details"] = {};
						commute_details[year][month]["daily_commute_details"][day] = {};
						commute_details[year][month]["daily_commute_details"][day]["commutes"] = [];
						commute_details[year][month]["carbon_stats"] = {
							"carbon_emitted": 0,
							"carbon_saved": 0,
							"leaf_points": 0
						}
					} else {
						if(my_tanso_details["commute_details"][year][month]["daily_commute_details"][day] == undefined) {
							commute_details[year][month]["daily_commute_details"][day] = {};
							commute_details[year][month]["daily_commute_details"][day]["commutes"] = [];
							commute_details[year][month]["carbon_stats"] = {
								"carbon_emitted": 0,
								"carbon_saved": 0,
								"leaf_points": 0
							}	
						}
					}
				}

				return commute_details;
	        }

	        var my_tanso;

	        function loadJSON(callback) {
			    var xobj = new XMLHttpRequest();
			    xobj.overrideMimeType("application/json");
			    xobj.open('GET', 'sample_data', true);
			    xobj.onreadystatechange = function () {
			    		// console.log(xobj.readyState);
			    		// console.log(xobj.status);
			          if (xobj.readyState == 4 && xobj.status == "200") {
			          	// console.log(xobj);
			            callback(xobj.responseText);
			          }
			    };
			    xobj.send(null);  
			}


	        function saveCommuteDetails(commute) {
	        	loadJSON(function(response) {
			    	my_tanso = JSON.parse(response);

			    	// console.log(my_tanso);
					var commute_details = rebuildCommuteDetails(my_tanso);
					commute_details[year][month]["daily_commute_details"][day]["commutes"].push(commute);

					var carbon_stats = commute_details[year][month]["carbon_stats"];
					carbon_stats["carbon_emitted"] += commute.totalCarbonEmission;
					carbon_stats["carbon_saved"] += commute.carbonSaved;
					carbon_stats["leaf_points"] += commute.rideLeafPoints;

					commute_details[year][month]["carbon_stats"] = carbon_stats;

					my_tanso["commute_details"] = commute_details;

					var total_carbon_stats = my_tanso["total_carbon_stats"];
					total_carbon_stats["total_carbon_emitted"] += commute.totalCarbonEmission;
					total_carbon_stats["total_carbon_saved"] += commute.carbonSaved;
					total_carbon_stats["total_leaf_points"] += commute.rideLeafPoints;

					my_tanso["total_carbon_stats"] = total_carbon_stats;

					localStorage.setItem("my_tanso", JSON.stringify(my_tanso));

					updateData();

					localStorage.removeItem("commute");
				});
	        }

	        function updateData() {
	        	let tanso_data = localStorage.getItem("my_tanso");

	        	var xhr = new XMLHttpRequest();
				xhr.open("POST", "/sample_data", true);
				xhr.setRequestHeader('Content-Type', 'application/json');
				xhr.send(JSON.stringify({
				    tanso_data_details: tanso_data
				}));
				xhr.onload = function() {
				  console.log("Tanso Details Updated");
				}
	        }
		  
		</script>
		<script src="./dist/bundle.js"></script>
		<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBnPKOObu8W8kngc9yiYesWpY4UHplvLao&callback=initMap">
    </script>
	</body>
</html>